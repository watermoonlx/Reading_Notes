- [一、文件基本权限](#一文件基本权限)
    - [1. 基本权限的修改](#1-基本权限的修改)
        - [查看权限](#查看权限)
        - [修改权限：`chmod`命令](#修改权限chmod命令)
    - [2. 权限的作用](#2-权限的作用)
        - [权限对文件的作用](#权限对文件的作用)
        - [权限对目录的作用](#权限对目录的作用)
    - [3. 其他权限命令](#3-其他权限命令)
        - [修改文件的所有者](#修改文件的所有者)
        - [修改文件的所属组](#修改文件的所属组)
- [二、文件默认权限](#二文件默认权限)
    - [查看默认权限的命令](#查看默认权限的命令)
    - [修改默认权限](#修改默认权限)
- [三、ACL权限](#三acl权限)
    - [3.1 ACL权限简介与开启](#31-acl权限简介与开启)
        - [ACL简介](#acl简介)
        - [查看分区ACL权限是否开启](#查看分区acl权限是否开启)
        - [临时开启分区ACL权限](#临时开启分区acl权限)
        - [永久开启分区ACL权限](#永久开启分区acl权限)
    - [3.2 查看与设定ACL权限](#32-查看与设定acl权限)
        - [查看ACL权限](#查看acl权限)
        - [设定ACL权限](#设定acl权限)
    - [3.3 最大有效权限与删除ACL权限](#33-最大有效权限与删除acl权限)
        - [最大有效权限mask](#最大有效权限mask)
        - [删除ACL权限](#删除acl权限)
    - [3.4 默认ACL权限和递归ACL权限](#34-默认acl权限和递归acl权限)
        - [递归ACL权限](#递归acl权限)
        - [默认ACL权限](#默认acl权限)
- [四、sudo权限](#四sudo权限)
    - [4.1 什么是sudo权限](#41-什么是sudo权限)
    - [4.2 sudo使用](#42-sudo使用)
- [五、文件特殊权限](#五文件特殊权限)
    - [5.1 `SetUID`](#51-setuid)
        - [`SetUID`的功能](#setuid的功能)
    - [5.2 `SetGID`](#52-setgid)
    - [5.3 `Sticky BIT`](#53-sticky-bit)
- [六、不可改变位权限](#六不可改变位权限)

# 一、文件基本权限

## 1. 基本权限的修改

### 查看权限
命令：`ls -l`或`ll`

文件权限默认是十位。

例：

```bash
-rw-r--r--
```

* 第一位代表文件类型。Linux中一共有七种文件类型（Linux不是靠扩展名来区分文件类型。Linux没有扩展名的概念）
  * `-`代表普通文件。
    * 纯文本文件（ascii）。
    * 二进制文件（binary）。
    * 数据格式文件（data）。
  * `d`：代表目录。
  * `l`：代表软链接文件。Symbol Link。
  * `c`：字符设备文件。如鼠标，键盘。
  * `b`：块设备文件。如硬盘。
  * `s`：套接口文件。
  * `p`：管道文件。
* 剩下九位，以每三位为一组，分别指定不同用户的`r`读、`w`写、`x`执行权限。
  * 2-4位。u所有者权限。
  * 5-7位。g所属组权限。
  * 8-10位。o其他人权限。

centOS 6之后，权限后面还多了一位，`.`。这个点代表ACL权限。

### 修改权限：`chmod`命令

`chmod [选项] 模式 文件名`
    * 选项
        * `-R` 递归修改
    * 模式
        * `[ugoa] [+-=] [rwx]`，这里`a`是所有人的意思。
        * `[***]`，`*`代表权限数字和。常用的有`777`，`755`,`644`。
            * `r`--`4`
            * `w`--`2`
            * `x`--`1`

例：
* `chmod u+x cangls.av`
* `chmod g+w,o+w furong.av`
* `chmod a=rwx fengjie.av`
* `chmod 755 fengjie.av`

## 2. 权限的作用

### 权限对文件的作用

* `r`：读取文件内容（`cat`，`more`，`head`，`tail`）。
* `w`：编辑、新增、修改文件内容（`vi`，`vim`, `echo`）。但是**不代表有权删除该文件**。必须对包含该文件的目录本身有写权限，才能删除该文件。换言之，**写权限是指对该文件所包含的内容有修改权**。
* `x`：可执行。

### 权限对目录的作用

* `r`：可以查询目录下文件名（`ls`）
* `w`：可以修改目录内结构。如新建文件和目录，删除此目录下文件和目录，重命名此目录下文件和目录，剪切（`touch`，`rm`，`mv`，`cp`）
* `x`：可以进入目录（`cd`）

## 3. 其他权限命令

### 修改文件的所有者

* `chown 用户名 文件名`
    * 例：`chown ds fengj.av`
    * 同时修改所有者和所属组：`chown 用户名:所属组 文件名`

### 修改文件的所属组

* `chgrp 组名 文件名`
    * 例：`chgrp group1 fengj.av`

# 二、文件默认权限

## 查看默认权限的命令

* `umask`
* 返回值`0022`
    * 第一位`0`：文件特殊权限
    * `022`：文件默认权限的掩码。`000 010 010`

文件默认权限计算方法：
* 文件默认不能建立为执行文件，必须手工赋予执行权限。所以文件默认权限最大值为`666`。
* 默认权限最大值换算成“字母形式”为`rw-rw-rw-`，`umask`值换算成“字母形式”为`----w--w-`
* 两者相减，得到最终默认权限位`rw-r--r--`，即`644`

目录默认权限的计算方法：
* 目录默认权限最大为`777`。
* 从中减去`umask`的`----w--w-`，最终得到`rwxr-xr-x`，即`755`。

## 修改默认权限

* 临时修改：`umask 0002`
* 永久修改：`vim /etc/profile`

# 三、ACL权限

## 3.1 ACL权限简介与开启

### ACL简介
文件默认权限只能提供三种角色控制：所有者、所属组、其他人。当面对更为复杂的权限控制场景时，三个角色不够用。
![ACL权限](https://images2017.cnblogs.com/blog/1120165/201711/1120165-20171108215330028-1269629412.png)

ACL权限用于解决这个问题。ACL可以单独针对某一用户和用户组配置权限。

### 查看分区ACL权限是否开启

* `dumpe2fs -h /dev/sda5`：`dumpe2fs`命令时查询指定分区详细文件系统信息的命令。
    * `-h`：仅显示超级块中信息，而不显示磁盘块组的详细信息。
* 在`Default mount options`字段中，查看是否有`acl`字段。若有，就是开启了。

在CentOS 7中使用上述命令会报错：
```
dumpe2fs 1.42.9 (28-Dec-2013)
dumpe2fs: Bad magic number in super-block 当尝试打开 /dev/sda5 时
找不到有效的文件系统超级块.
```
原因是CentOS 7默认文件系统类型是`xfs`，CentOS 6默认是`ext4`。`dumpe2fs`命令只适用于`ext4`，用于查看文件系统状态。而要查看`xfs`文件系统状态，需要使用`xfs_growfs`命令。不过通过这个命令看不到是否开启了ACL。从网上提供的信息来看，`xfs`似乎默认强制开启了`acl`，
参考资料：[https://jingyan.baidu.com/article/a65957f4c812ee24e77f9b63.html](https://jingyan.baidu.com/article/a65957f4c812ee24e77f9b63.html)

查看文件系统类型的命令：`df -Th`

### 临时开启分区ACL权限

* `mount -o remount,acl /`：重写挂载根分区，并加入acl权限。

### 永久开启分区ACL权限

* `vim /etc/fstab`
* `mount -o remount /`

## 3.2 查看与设定ACL权限

### 查看ACL权限

* `getfacl 文件名`

### 设定ACL权限

* `setfacl 选项 文件名`
    * `-m`：设定ACL权限
        * 给单个用户设定ACL权限：`setfacl -m u:用户名:权限值 文件`
        * 给单个用户组设定ACL权限：`setfacl -m g:组名:权限值 文件`
    * `-x`：删除指定的ACL权限
    * `-b`：删除所有的ACL权限
    * `-d`：设定默认ACL权限
    * `-k`：删除默认ACL权限
    * `-R`：递归设定ACL权限

## 3.3 最大有效权限与删除ACL权限

### 最大有效权限mask
* `mask`是用来指定最大有效权限的。如果我给用户赋予了ACL权限，是需要和mask的权限“相与”才能得到用户的真正权限。

修改最大有效权限
* `setfacl -m m:权限值 文件名`：设定mask权限位`r-x`。

### 删除ACL权限
* `setfacl -x u:用户名 文件名`：删除指定用户的ACL权限。
* `setfacl -x g:组名 文件名`：删除指定用户组的ACL权限。
* `setfacl -b 文件名`：删除文件的所有ACL权限。

## 3.4 默认ACL权限和递归ACL权限

### 递归ACL权限

* 递归ACL权限：给父目录设定ACL权限时，所有**已经存在的**子文件和子目录也会拥有相同的ACL权限。
* 命令：`setfacl -m u:用户名:权限值 -R 目录名`
* 使用递归设定，非常容易造成“权限溢出”。因为一般我们给目录赋权限，都会给执行权限（`x`）。如果使用递归（`-R`），则该目录下所有文件都会成为可执行的，这非常不安全。

### 默认ACL权限

* 默认ACL权限：如果给父目录设定了默认ACL权限，那么父目录中所有**新建的**子文件都会继承父目录的ACL权限。
* `setfacl -m d:u:用户名:权限值 目录名`

# 四、sudo权限

## 4.1 什么是sudo权限

* root用户可把本来只能由root执行的命令(`/sbin/`)授权给特定的普通用户执行，**且不需要输入root密码**。
* sudo的操作对象是系统命令（`/sbin/`）。

## 4.2 sudo使用

* sudo权限的配置：`visudo`
    * 实际修改的是`/etc/sudoers`文件。

配置格式：
* `user1 ALL=(ALL) ALL`
    * `目标用户名 被管理主机的地址=(可使用的身份) 授权命令(绝对路径)`
    * 若省略`(可使用的身份)`，那么用户输入该命令时，会以root用户身份执行，这有很大的安全隐患。
    * 例：允许user1用户重启：`user1 ALL=(ALL) /sbin/shutdown -r now`
* `%wheel ALL=(ALL) ALL`
    * `%目标组名 被管理主机的地址=(可使用的身份) 授权命令(绝对路径)`

危险常见举例：
* 让用户可以以`root`身份执行`passwd`，从而修改root用户的密码。
* 让用户可以以`root`身份执行`vim`或`vi`，从而修改任何配置文件。

普通用户在执行sudo权限的命令时，需要在命令前加上`sudo`。
* `sudo /sbin/shutdown -r now`
* 查看可用的sudo命令：`sudo -l`

# 五、文件特殊权限

## 5.1 `SetUID`

### `SetUID`的功能

> 当一个具有执行权限的文件设置SetUID权限后，用户执行这个文件时将以文件所有者的身份执行

* 只有可以执行的二进制程序才能设定SUID权限。
* 命令执行者要对该程序拥有x（执行）权限
* 命令执行者在执行该程序时获得该程序文件属主的身份（在执行程序的过程中灵魂附体为该文件的属主）。
* SetUID权限只在该程序执行过程中有效，也就是说身份改变只在程序执行过程中有效。

## 5.2 `SetGID`

> 类似于setuid，它会把有效用户组ID从该用户的实际组ID更改为该文件所有者的组ID。

## 5.3 `Sticky BIT`

> 我们知道/tmp是系统的临时文件目录，所有的用户在该目录下拥有所有的权限，也就是说在该目>录下可以任意创建、修改、删除文件，那如果用户A在该目录下创建了一个文件，

> 用户B将该文件删除了，这种情况我们是不能允许的。为了达到该目的，就出现了stick  bit(粘滞位)的概念。它是针对目录来说的，如果该目录设置了stick  bit(粘滞位)，则该目录下的文件除了该文件的创建者和root用户可以删除和修改/tmp目录下的stuff，别的用户均不能动别人的，这就是粘滞位的作用。

# 六、不可改变位权限

  chattr: 锁定文件，不能删除，不能更改
        +a:  只能给文件添加内容，但是删除不了，
              chattr +a  /etc/passwd
        -d:      不可删除
        加锁：chattr +i  /etc/passwd       文件不能删除，不能更改，不能移动
        查看加锁： lsattr /etc/passwd      文件加了一个参数 i 表示锁定
        解锁：chattr -i /home/omd/h.txt    - 表示解除
        隐藏chattr命令：
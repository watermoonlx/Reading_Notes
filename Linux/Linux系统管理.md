- [1.进程管理](#1进程管理)
    - [1.1 进程管理简介](#11-进程管理简介)
        - [(1) 进程简介](#1-进程简介)
        - [(2) 进程管理的作用](#2-进程管理的作用)
    - [1.2 进程的查看](#12-进程的查看)
        - [查看所有进程：`ps aux`](#查看所有进程ps-aux)
        - [PS命令的输出（`ps aux`）](#ps命令的输出ps-aux)
        - [查看进程树：`pstree`](#查看进程树pstree)
        - [查看系统健康状态：`top`](#查看系统健康状态top)
    - [1.4 杀死进程](#14-杀死进程)
    - [1.5 修改进程优先级](#15-修改进程优先级)
- [2.工作管理](#2工作管理)
    - [2.1 工作管理简介](#21-工作管理简介)
    - [2.2 工作管理方法](#22-工作管理方法)
    - [2.3 后台命令脱离登录终端执行](#23-后台命令脱离登录终端执行)
- [3.系统资源查看](#3系统资源查看)
    - [3.1 `vmstat`命令监控系统资源](#31-vmstat命令监控系统资源)
    - [3.2 `dmesg`开机时内核检测信息](#32-dmesg开机时内核检测信息)
    - [3.3 `free`命令查看内存使用状态](#33-free命令查看内存使用状态)
    - [3.4 查看CPU信息](#34-查看cpu信息)
    - [3.5 `uptime`命令](#35-uptime命令)
    - [3.6 查看系统与内核相关信息](#36-查看系统与内核相关信息)
    - [3.7 列出进程打开或使用的文件信息](#37-列出进程打开或使用的文件信息)
- [4.系统定时任务](#4系统定时任务)
    - [4.1 at一次性定时任务（延迟执行）](#41-at一次性定时任务延迟执行)
    - [4.2 crontab循环定时任务](#42-crontab循环定时任务)
    - [4.3 系统的crontab设置](#43-系统的crontab设置)
    - [4.4 anacron配置](#44-anacron配置)

# 1.进程管理

## 1.1 进程管理简介

### (1) 进程简介

> 进程是正在执行的一个程序或命令。每一个进程都是一个运行的实体，都有自己的地址空间，并占用一定的系统资源。

### (2) 进程管理的作用

* 判断服务器健康状态
* 查看系统中所有进程
* 杀死进程

## 1.2 进程的查看

### 查看所有进程：`ps aux`
* `ps aux`：查看系统中所有进程。BSD操作系统格式。
    * `a`：显示一个终端的所有进程，除了会话引线。
    * `u`：显示进程的归属用户和内存使用情况。
    * `x`显示没有控制终端的进程。
* `ps -le`：查看系统中所有进程。Linux命令格式。两条命令输出有些不同。
    * `-l`：长格式显示。显示更加详细的信息。
    * `-e`：显示所有进程。和`-A`作用一致。

### PS命令的输出（`ps aux`）
| 字段    | 含义                                                                                                                                                                         |
| ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| USER    | 该进程是有那个用户产生的。                                                                                                                                                   |
| PID     | 进程的ID号。                                                                                                                                                                 |
| %CPU    | 该进程占用的CPU资源的百分比。占用越高，进程越耗费资源。                                                                                                                      |
| %MEM    | 该进程占用物理内存的百分比。占用越高，进程越耗费资源。                                                                                                                       |
| VSZ     | 该进程占用虚拟内存的大小，单位KB。                                                                                             v                                             |
| RSS     | 该进程占用实际物理内存的大小，单位KB。                                                                                                                                       |
| TTY     | 该进程是在哪个终端中运行的。其中tty1-tty7代表本地控制台终端。tty1-tty6是本地的字符界面终端（可通过Alter+F123456切换），tty7是图形终端。pts/0-255代表虚拟终端，比如远程终端。 |
| STAT    | 进程状态。常见状态见下方。                                                                                                                                                   |
| START   | 启动时间                                                                                                                                                                     |
| TIME    | 当前进程耗费的CPU运行时间                                                                                                                                                    |
| COMMAND | 产生该进程的命令名                                                                                                                                                           |

STAT常见状态：
* R：运行
* S：睡眠
* T：停止
* s：包含子进程
* +：属于前台进程组
* <:优先级高的进程
* N：优先级低的进程
* l：多进程

### 查看进程树：`pstree`

`pstree [选项]`
* `-p`：显示进程的PID。
* `-u`：显示进程的所属用户。


CentOS 7默认没有安装该命令。需安装`yum install -y psmisc`

### 查看系统健康状态：`top`

`top [选项]`
* `-d 秒数`：指定top命令每隔几秒更新。默认是3秒。
* `-b`：使用批处理模式输出。一般和`-n`选项合用。
* `-n 次数`：指定top命令执行的次数。一般和`-b`选项合用。主要用于输出到文件。
    * `top -b -n 1 > /root/top.log`

在top命令的监护模式当中可以执行的命令：
* `?`或`h`：显示交互模式的帮助。
* `P`：以CPU占用率排序，默认就是此项。
* `M`：以内存占用率排序。
* `N`：以PID排序。
* `q`：退出top程序。

top命令界面首部信息
* 第一行：任务队列信息
| 内容                           | 说明                                                                                                                                                                                          |
| ------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 12:26:26                       | 系统当前时间                                                                                                                                                                                  |
| up 1 day, 13:32                | 系统已运行时间                                                                                                                                                                                |
| 2 users                        | 当前有两个登录用户                                                                                                                                                                            |
| load average: 0.00, 0.00, 0.00 | 系统在之前1分钟，5分钟，15分钟的平均负载，即任务队列的平均长度。按照CPU核心数目确定基准值。比如双核CPU，基准值是2。一般认为小于基准值时，负载较小。如果大于基准值，代表系统已经负荷可能过大。 |

* 第二行：进程信息
| 内容            | 说明                                        |
| --------------- | ------------------------------------------- |
| Tasks: 95 total | 系统中的进程总数。                          |
| 1 running       | 正在运行的进程数 。                         |
| 94 sleeping     | 睡眠的进程。                                |
| 0 stopped       | 正在停止的进程。                            |
| 0 zombie        | 僵尸进程。如果不是0，需要手工检查僵尸进程。 |

* 第三行：CPU信息
| 内容    | 说明                                    |
| ------- | --------------------------------------- |
| Cpu(s): | Title                                   |
| 0.1 us  | 用户模式占用的CPU百分比。               |
| 0.1 sy  | 系统占用的CPU百分比。                   |
| 0.0 ni  | 改变过优先级的用户进程占用的CPU百分比。 |
| 99.7 id | 空闲CPU的CPU百分比。                    |
| 0.1 wa  | 等待输入/输出的进程的占用CPU百分比。    |
| 0.0 hi  | 硬中断请求服务占用的CPU百分比。         |
| 0.1 si  | 软中断请求服务占用的CPU百分比。         |
| 0.0 st  | st（steal time）虚拟时间百分比。        |

* 第四行：物理内存信息
| 内容             | 说明                                       |
| ---------------- | ------------------------------------------ |
| KiB Mem:         | Title                                      |
| 625344 total     | 物理内存的总览，单位KB。                   |
| 571504 used      | 以纳入内核管理的内存数量。该值会一直增加。 |
| 53840 free       | 还未纳入内核管理的内存数量。               |
| 64800 buff/cache | 作为缓存的内存数量。                       |

* 第五行：交换分区信息
| 内容            | 说明                                               |
| --------------- | -------------------------------------------------- |
| KiB Swap:       | Title                                              |
| 625344 total    | 交换分区总大小，单位KB。                           |
| 571504 used     | 已经使用的交换分区数量。                           |
| 64800 avail Mem | 实际的空闲物理内存量。这个值才真正表示内存剩余量。 |

## 1.4 杀死进程

1.kill命令
终止单一进程。

* `kill -l`：查看可用的信号
    * `1`：平滑重启。
    * `9`：强制关闭。
    * `15`：正常结束进程，kill命令的默认信号。

* `kill [-信号] [PID]`
    * `kill 1234`：正常关闭PID为1234的进程。
    * `kill -9 1234`：强制关闭PID为1234的进程。
    * `kill -1 1234`：平滑重启PID为1234的进程。

2.killall命令
依据进程名杀死一组进程。

* `killall [信号] [选项] 进程名`
    * 选项：
        * `-i`：交互式。在杀死一个进程前，询问是否要杀死该进程。
        * `-I`：匹配进程名时忽略大小写。

3.pkikk命令
依据进程名杀死一组进程。

* `pkill [信号] [选项] 进程名`
    * 选项：
        * `-t 终端号`：按照终端号踢出用户。

## 1.5 修改进程优先级

Linux操作系统是一个多用户、多任务的操作系统。Linux系统中同时运行着非常多的进程。但是一个CPU在同一个时钟周期内只能运算一个指令。进程优先级决定了每个进程处理的先后顺序。

* 查看进程优先级：`ps -le`
进程优先级指标：
    * `PRI`：Priority。实际优先级
    * `NI`：Nice。
这两个值都是优先级，数字越小代表进程优先级越高。每个进程有个默认优先级。
> Priority=默认优先级+Nice
用户只能修改`NI`。

修改NI值的注意事项：
* NI的值范围是-20到19；
* 普通用户调整NI值的范围是0到19，而且只能调整自己的进程。
* 普通用户只能调高NI值，而不能降低（即只能降低优先级）。
* root用户才能设定进程NI值为负值，而且可以调整任何用户的进程。

修改优先级：
* `nice [选项] 命令`：nice命令可以给新执行的命令直接赋予NI值，但是不能修改已经存在的进程的NI值。
    * `-n NI值`：给命令赋予NI值。

* `renice [优先级] PID`：修改已经存在的进程的NI值。

# 2.工作管理

## 2.1 工作管理简介

工作管理指在单个登录终端中（也就是登录的shell界面中）同时管理多个工作的行为。也就是将程序放入后台执行。

注意事项：
* 当前的登录终端，只能管理当前终端的工作，而不能管理其他登录终端的工作。当关闭当前终端时，当前终端的所有后台程序（很可能）会一同关闭。
* 放入后台的命令必须可以执行执行一段时间，这样我们才能捕捉和操作这个工作。
* 放入后台执行的命令不能和前台用户有交互或需要前台输入，否则放入后台只能暂停，而不能执行。

## 2.2 工作管理方法

把进程放入后台：
* 方法一：`命令 &`，把命令放入后台，并在后台执行。
* 方法二：在前台命令执行过程中，然后按下`ctrl+z`，将当前进程放入后台，并暂停执行。

查看后台的工作：
* `jobs [-l]`：
    * `-l`：显示工作的PID。
注：“+”号代表最近一个放入后台的工作，也是工作恢复时，默认恢复的工作。“-”代表倒数第二个放入后台的工作。

将后台暂停的工作恢复到前台执行
* `fg %工作号`
    * `- %工作号`：%号可以省略。但要注意工作号是通过`jobs`命令查询，和PID是不同的。
    * 若直接输入`fg`，则恢复最近放入后台的工作，即带`+`的。

把后台暂停的工作恢复到后台执行
* `bg %工作号`
    * 恢复后台执行的命令，是不能和前台有交互的（不能读取标准输入），否则不能恢复到后台执行。
    * 若直接输入`bg`，则恢复最近放入后台的工作，即带`+`的。

## 2.3 后台命令脱离登录终端执行

默认情况下，放入后台的工作与当前终端绑定。一旦退出或关闭终端，后台工作也会关闭。

后台命令脱离登录终端执行的方法：
* 方法一：使用`nohup`命令
    * `nohup 命令 &`
* 方法二：使用系统定时任务，让系统在指定时间执行某个后台命令

# 3.系统资源查看

## 3.1 `vmstat`命令监控系统资源
* `vmstat [刷新间隔 刷新次数]`

输出说明：
* `procs`：进程信息字段。
    * `r`：等待运行的进程数。数量越大，系统越繁忙。
    * `b`：处在非中断睡眠状态的进程数。数量越大，系统越繁忙。
* `memory`：内存信息字段，单位KB。
    * `swpd`：虚拟内存使用情况。
    * `free`：空闲的内存容量。
    * `buff`：缓冲的内存容量。
    * `cache`：缓存的内存容量。
* `swap`：交换分区的信息字段，单位KB。
    * `si`：从磁盘中交换到内存中的数据量。
    * `so`：从内存中交换到磁盘中的数据量。这两个指标越大，证明数据需要进程在磁盘和内存之间交换，系统性能越差。
* `io`：磁盘读写信息字段，单位是块/s。
    * `bi`：发送到块设备的块数。
    * `bo`：从块设备接收到的块数。此两个数越大，代表系统的I/O月繁忙。
* `system`：系统信息字段。
    * `in`：每秒的中断数。
    * `cs`：每秒的环境（上下文）切换数。这两个指标越大，代表系统与繁忙。
* `CPU`：CPU信息字段，单位百分比。
    * `us`：非内核进程消耗的CPU运算时间。
    * `sy`：内核进程消耗的CPU运算时间。
    * `id`：空闲CPU的百分比。
    * `wa`：等待I/O所消耗的CPU百分比。
    * `st`：被虚拟机所盗用的CPU百分比。

buff（缓冲）和cache（缓存）的区别：
buffer是用来加速数据“写入”硬盘的。cache是用来加速从硬盘中“读取”的。

## 3.2 `dmesg`开机时内核检测信息
可用于查看硬件信息。

## 3.3 `free`命令查看内存使用状态
* `free [选项]`
    * `-b`：以字节为单位显示。
    * `-k`：以KB为单位显示。默认选项。
    * `-m`：以MB为单位显示。
    * `-g`：以GB为单位显示。

## 3.4 查看CPU信息
* `cat /proc/cpuinfo`

## 3.5 `uptime`命令
* `uptime`：top命令第一行

## 3.6 查看系统与内核相关信息
* `uname [选项]`
    * `-a`：查看系统所有信息版本。
    * `-r`：查看内核版本。
    * `-s`：查看内核名称。

* 判断当前系统位数：`file /bin/ls`
* 查询当前Linux系统的发行版本：`lsb_release -a`

## 3.7 列出进程打开或使用的文件信息
* `lsof [选项]`：列出进程调用或打开的文件信息。
    * `-c 字符串`：只列出以字符串开头的进程打开的文件。
    * `-u 用户名`：只列出某个用户的进程打开的文件。
    * `-p pid`：列出某个PID进程打开的文件。

例：`lsof | less`

# 4.系统定时任务

## 4.1 at一次性定时任务（延迟执行）

确定是否安装并启用了at服务：
* `chkconfig --list | grep atd`
* `service atd restart`

at的访问控制：
* 如果系统中有`/etc/at.allow`文件，那么只有写入此文件（白名单）中的用户可以使用at命令（`/etc/at.deny`会被忽略）
* 如果系统中没有`/etc/at.allow`文件，但有`/etc/at.deny`文件，那么此文件（黑名单）的用户不能使用at命令。对root不起作用。（如果有`/etc/at.deny`，但是空的，那么所有用户都可以使用at命令）
* 如果系统中这两个文件都不存在，那么只有root用户可以使用at命令。

at命令
* `at [选项] 时间`
    * `-m`：当at工作完成后，无论命令是否有输出，都用email通知运行at命令的用户。
    * `-c 工作号`：显示该at工作的实际内容。工作号使用`atq`命令查看，输出结果的第一列。
* 时间格式：
    * HH:MM
    * HHM:MM YYYY-MM-DD
    * HH:MM [am|pm] [month] [date]
    * HH:MM [am|pm] + [minutes|hours|days|weeks]
    * now
* 举例
    * 输入`at now + 5 minutes`，进入at交互界面，等待输入五分钟后要执行的命令。
    * 输入命令。输入错误时，使用`ctrl+退格键`删除输入字符。
    * 输入`ctrl+D`保存退出。

查看at任务
* `atq`

删除at任务
* `atrm 工作号`

## 4.2 crontab循环定时任务

crond服务管理与访问控制：
* 如果系统中有`/etc/cron.allow`文件，那么只有写入此文件（白名单）中的用户可以使用at命令（`/etc/cron.deny`会被忽略）
* 如果系统中没有`/etc/cron.allow`文件，但有`/etc/cron.deny`文件，那么此文件（黑名单）的用户不能使用at命令。对root不起作用。（如果有`/etc/cron.deny`，但是空的，那么所有用户都可以使用at命令）
* 如果系统中这两个文件都不存在，那么只有root用户可以使用at命令。

用户的crontab设置
* `crontab [选项]`
    * `-e`：打开vim，编辑crontab任务。保存后退出即可生效。只能添加自己权限范围内的任务。如果本身无权限执行某些操作，那么放置定时任务中也没法执行。
    * `-l`：查询crontab任务。
    * `-r`：删除当前用户所有crontab任务。
* 任务格式：
```shell
minute hour day-of-month month-of-year day-of-week 后跟执行的任务。可以是命令，也可以是一个shell脚本。
```
| 项目          | 含义                 | 取值范围                             |
| ------------- | -------------------- | ------------------------------------ |
| minute        | 每个小时中的第几分钟 | 0-59（可见最快频率是每分钟执行一次） |
| hour          | 每天的第几个小时     | 0-23                                 |
| day-of-month  | 每个月的第几天       | 1-31                                 |
| month-of-year | 每年的第几个月       | 1-12                                 |
| day-of-week   | 每周的星期几         | 0-7（0和7都代表星期日）              |

特殊取值：
* `*`：代表取值范围内的每个值，即“全部”，“每个”。注意尽量不要在minute位置上写`*`，那会导致每分钟都执行。
* `/`：代表以指定分数分割时间范围。比如`*/5`代表所有值且间隔5个单位执行。放置minute位置，就是“每5分钟”。放置hour位置，就是“每5个小时”。再比如`0-23/3`，就是在0-23这个范围内，每隔3个单位执行。
* `-`：代表从某个数字到某个数字。
* `,`：用于分割几个离散的值。

读时间的时候从后往前读。

特别注意：
* 留个选项都不能为空，必须填写。如果某单位无限制，则用`*`代表。但尽量不要在minute位置上使用`*`，那会导致每分钟都执行。
* crontab定时任务，最小时间间隔单位是分钟。
* 每个月第几天和星期几同时指定时，只要满足一个，就执行，即取得是交集，而不是取交集。这非常容易引起误导，因此尽量不要同时指定。
* 在定时认为中，不管是直接写命令，还是在脚本中写命令，都最好用绝对路径。因为crontab执行时的path变量值和系统本身设置的path变量值不完全一样，因此可能出现执行时找不到命令的情况。

## 4.3 系统的crontab设置

`crontab -e`是每个用户执行的命令。也就是说，定时任务直接和用户绑定（用户退出登录后定时任务会继按时执行）。可是有些定时任务需要系统执行，这时我们就需要编辑`/etc/crontab`这个配置文件了。与普通`crontab -e`命令相比，编辑`/etc/crontab`文件可以指定执行的用户，因此也只有root用户可以修改该文件。

定时任务的最简单方式：将编写好的脚本放入`/etc/cron.{daily,weeekly,monthly}`这些目录下，这些脚本即可每天、每周、每月自动执行，不用其他配置。

## 4.4 anacron配置

anacron是什么？
* anacron是用来保障系统关系的时候错过的定时任务，可以在系统开机之后再执行。

anacron检测周期
* anacron会使用一天，七天，一个月作为检测周期。
* 在系统的`/var/spool/anacron/`目录中存在`cron.{daily,weekly,monthly}`文件，用于记录上次执行cron任务的时间。
* 和当前时间做比较，如果两个时间的差值超过了anacron的指定时间差值，证明cron任务漏执行了。

CentOS 6与之前版本的区别
* 在老的CentOS版本中，`/etc/cron.{daily,weeekly,monthly}`这些目录既会被cron调用，也会白anacron调用，容易重复执行。
* 在CentOS 6之后，只会被anacron调用，避免了重复执行。
* 在CentOS 6之后，anacron不再是服务，而是系统命令。

anacron配置文件
* `/etc/anacrontab`
    * `RANDOM_DALAY=45`：最大随机延迟。用于错峰执行机制。
    * `START_HOURS_RANGE=3-22`：执行时间范围。

默认配置下`cron.daily`工作来说明执行过程
* 首先读取`/var/spool/anacron/cron.daily`中的上一次anacron执行时间。
* 和当前时间做比较，如果两个时间的差值超过1天，就执行cron.daily工作。
* 执行这个工作职能在03:00-22:00之间。
* 执行工作时强制延迟时间为5分钟，再随机延迟0-45分钟时间。
* 使用nice命令指定默认优先级，使用`run-parts`脚本执行`/etc/cron.daily`目录下的所有可执行文件。
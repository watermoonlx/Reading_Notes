# 10. 中间件

### 什么是中间件？

* 从概念上来说，中间件是一种功能的封装方式，具体来说就是封装在程序中处理HTTP请求的功能。
* 从实战上来说，中间件只是一个有3个参数的函数：一个请求对象，一个响应对象，和一个next函数。（还有一种4个参数的形式，用来做错误处理。）

### 中间件组成请求处理管道

中间件组成请求处理管道。在处理请求时，中间件将按照添加顺序依次被调用。

注意，在Express 4.0之后，中间件和路由处理器都是按照他们的添加顺序被调用的，顺序更清晰。

如果一个中间件不调用next()函数，则请求就终止了，其后添加的中间件将不会被调用。

在管道最后，放置一个“捕获一切”请求的中间件是常见的做法，用于处理与其他路由都不匹配的请求。

### 中间件与路由处理器

* 路由处理器（app.get, app.post等）可以被看做**只处理特定HTTP谓词**（GET、POST等）的中间件。同样，中间件可看做可以处理全部HTTP谓词的路由处理器。
* 路由处理器的第一个参数必须是路径。若想让某个路由处理器匹配所有路径，只需要使用/*。中间件也可以将路径作为第一个参数，但它是可选地。若忽略，则会匹配所有路径。
* 路由处理器和中间件的参数中都有回调函数，这个函数有2个、3个或4个参数。
  * 若有2个参数：请求对象，响应对象。
  * 若有3个参数：请求对象，响应对象，next函数。
  * 若有4个参数：错误对象，请求对象，响应对象，next函数。
* 若不调用next()，则管道会被终止，后续路由处理器和中间件都不会再被调用（若有的话）。如果你不调用next()，则应该发送一个响应到客户端（res.send，res.json，res.render等）。若不这样做，则客户端会被挂起，并最终超时。
* 若调用了next()，一般不宜再发送响应到客户端。如果发送了，则后续中间件或路由处理器发送的任何响应（在调用next时执行的发送）都会被覆盖。



## 常用中间件



